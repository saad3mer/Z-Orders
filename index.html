<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Z-Orders Tracker</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
body { font-family: Arial; direction: rtl; background: #eef2f7; padding: 20px; }
.container { max-width: 1200px; margin: auto; }
.box { background: #fff; padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
h3 { text-align: center; color: #333; margin-bottom: 20px; }
label { display:block; margin-top:15px; font-weight: bold; color: #555; }
input { width: 100%; padding: 12px; margin-top:5px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; transition: border 0.3s; }
input:focus { border-color: #4CAF50; outline: none; }
button { padding: 12px; cursor: pointer; font-size: 16px; border-radius: 8px; border: none; display: flex; justify-content: center; align-items: center; gap: 8px; transition: all 0.2s ease; }
button:active { transform: scale(0.95); opacity: 0.8; }
.generate-btn { width: calc(50% - 5px); background-color: #4CAF50; color: white; }
.copy-btn { width: calc(50% - 5px); background-color: #2196F3; color: white; }
.copy-btn:hover { background-color: #0b7dda; }
.search-container { display: flex; gap: 10px; margin-top: 15px; }
.search-container input { flex: 1; }
.search-container button { flex: 0 0 150px; background-color:#FF9800; color:white; border-radius:6px; }
.table-wrapper { max-height: 600px; overflow-y: auto; margin-top: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 12px; text-align: center; }
th { background-color: #4CAF50; color: white; }
tr:nth-child(even) { background-color: #f2f2f2; }
.date-time { white-space: nowrap; }
.order-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background-color: #4CAF50; color: white; padding: 15px 25px; border-radius: 10px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: all 0.5s ease; z-index: 1000; }
.order-popup.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.last-order { background-color: #FFF59D !important; font-weight:bold; }
</style>
</head>
<body>

<div class="container">
<div class="box">
<h3>ğŸ”¢ ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø£Ù…Ø±</h3>
<label>Ø§Ù„Ù…Ø¨Ù„Øº:</label>
<input id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<div style="display:flex; gap:10px; margin-top:10px;">
    <button class="generate-btn" onclick="generateOrder()"><i class="fa fa-plus"></i> ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯</button>
    <button class="copy-btn" onclick="copyOrder()"><i class="fa fa-copy"></i> Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±</button>
</div>

<h3 style="margin-top:30px;">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„ÙŠØ©</h3>
<div class="search-container">
    <input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±">
    <button onclick="searchOrder()"><i class="fa fa-search"></i> Ø¨Ø­Ø«</button>
</div>

<h3 style="margin-top:30px;">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h3>
<div class="table-wrapper">
<table id="ordersTable">
    <thead>
        <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
</div>
</div>

<div id="orderPopup" class="order-popup"></div>

<script>
let lastOrderNumber = ""; 

const SHEET_URL = "https://script.google.com/macros/s/AKfycbzIsr-QZ_xZmdwFIKQONdgE2P-LE7yX_ODtIP0bXj8lcoKqXgiijyhnuy_al06we_GV/exec";

function getToday() {
  const d = new Date();
  return d.getFullYear().toString() +
         String(d.getMonth()+1).padStart(2,'0') +
         String(d.getDate()).padStart(2,'0');
}

function addOrderToSheet(orderNumber, amount, dateTime){
  const body = new URLSearchParams({ orderNumber, amount, dateTime });
  fetch(SHEET_URL, { method: "POST", body })
    .then(res => res.text())
    .then(res => console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…:", res))
    .catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…:", err));
}

function generateOrder() {
  const amount = document.getElementById("amount").value.trim();
  if(!amount || isNaN(amount)) { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø±Ù‚Ù… ØµØ­ÙŠØ­"); return; }

  const today = getToday();
  const key = "orders_" + today;
  let count = localStorage.getItem(key);
  count = count ? parseInt(count) + 1 : 1;
  localStorage.setItem(key, count);

  const orderNumber = `Z-${today}${String(count).padStart(6,'0')}`;
  lastOrderNumber = orderNumber;

  const data = { amount: amount, date: new Date().toLocaleString() };
  localStorage.setItem(orderNumber, JSON.stringify(data));

  addOrderToSheet(orderNumber, amount, data.date);

  document.getElementById("amount").value = "";
  showOrderPopup(orderNumber);
  loadOrdersFromSheet();
}

function showOrderPopup(orderNumber) {
  const popup = document.getElementById("orderPopup");
  popup.textContent = `Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±: ${orderNumber}`;
  popup.classList.add("show");
}

function hideOrderPopup() {
  const popup = document.getElementById("orderPopup");
  popup.classList.remove("show");
}

function copyOrder() {
  if(lastOrderNumber === "") return;
  navigator.clipboard.writeText(lastOrderNumber);
  hideOrderPopup();

  const btn = document.querySelector(".copy-btn");
  btn.innerHTML = '<i class="fa fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
  setTimeout(()=>{ btn.innerHTML = '<i class="fa fa-copy"></i> Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø±'; }, 1000);
}

function searchOrder() {
  const val = document.getElementById("searchInput").value.trim();
  if(!val) return loadOrdersFromSheet();

  const tbody = document.getElementById("ordersTable").querySelector("tbody");
  tbody.innerHTML = "";

  loadOrdersFromSheet().then(()=>{
    for(const row of tbody.querySelectorAll("tr")){
      if(!row.children[0].textContent.includes(val)){
        row.style.display = "none";
      }
    }
  });
}

async function loadOrdersFromSheet() {
  const res = await fetch(SHEET_URL);
  const raw = await res.json();

  const rows = raw.slice(1); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
  const orders = rows
    .filter(r => r[0] && r[0].startsWith("Z-"))
    .map(r => ({ order: r[0], amount: r[1], date: r[2] }));

  orders.sort((a,b) => b.order.localeCompare(a.order));

  const tbody = document.getElementById("ordersTable").querySelector("tbody");
  tbody.innerHTML = "";

  orders.forEach((item,index)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${item.order}</td>
          <td>${item.amount}</td>
          <td class="date-time">${item.date}</td>
      `;
      if(index===0) tr.classList.add("last-order");
      tbody.appendChild(tr);
  });
}

// ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener("load", () => {
  loadOrdersFromSheet();
});

// Enter Ù„ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù…
document.getElementById("amount").addEventListener("keydown", function(e) {
    if(e.key === "Enter") generateOrder();
});

// Enter Ù„Ù„Ø¨Ø­Ø«
document.getElementById("searchInput").addEventListener("keydown", function(e) {
    if(e.key === "Enter") searchOrder();
});
</script>
</body>
</html>
